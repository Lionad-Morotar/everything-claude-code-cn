---
description: 重述需求，评估风险，并制定分步实施计划。在触任何代码之前等待用户确认。
---

# 计划命令

此命令调用**规划者**代理，在编写任何代码之前创建全面的实施计划。

## 此命令的功能

1. **重述需求** - 明确需要构建的内容
2. **识别风险** - 发现潜在问题和障碍
3. **创建步骤计划** - 将实施分解为阶段
4. **等待确认** - 必须在继续之前获得用户批准

## 使用时机

使用 `/plan` 当：
- 开始新功能
- 进行重大架构变更
- 处理复杂重构
- 多个文件/组件将受到影响
- 需求不明确或含糊

## 工作原理

规划者代理将：

1. **分析请求** 并清晰表述需求
2. **分解为阶段** 包含具体、可操作的步骤
3. **识别组件间依赖关系**
4. **评估风险** 和潜在障碍
5. **估算复杂度**（高/中/低）
6. **呈现计划** 并等待您的明确确认

## 示例用法

```
用户：/plan 我需要在市场结算时添加实时通知

代理（规划者）：
# 实施计划：实时市场结算通知

## 需求重述
- 当用户关注的市场结算时向用户发送通知
- 支持多种通知渠道（应用内、邮件、webhook）
- 确保通知可靠送达
- 包括市场结果和用户的持仓结果

## 实施阶段

### 阶段 1：数据库模式
- 添加通知表，包含字段：id、user_id、market_id、type、status、created_at
- 添加 user_notification_preferences 表用于渠道偏好设置
- 为 user_id 和 market_id 创建索引以提升性能

### 阶段 2：通知服务
- 在 lib/notifications.ts 中创建通知服务
- 使用 BullMQ/Redis 实现通知队列
- 为失败的投递添加重试逻辑
- 创建通知模板

### 阶段 3：集成点
- 在市场结算逻辑中钩入（状态变为“已结算”时）
- 查询所有在该市场中有持仓的用户
- 为每个用户入队通知

### 阶段 4：前端组件
- 在 header 中创建 NotificationBell 组件
- 添加 NotificationList 模态框
- 通过 Supabase 订阅实现实时更新
- 添加通知偏好页面

## 依赖项
- Redis（用于队列）
- 邮件服务（SendGrid/Resend）
- Supabase 实时订阅

## 风险
- 高：邮件送达率（需设置 SPF/DKIM）
- 中：单个市场有 1000+ 用户时的性能
- 中：若市场频繁结算可能导致通知泛滥
- 低：实时订阅开销

## 预估复杂度：中等
- 后端：4-6 小时
- 前端：3-4 小时
- 测试：2-3 小时
- 总计：9-13 小时

**等待确认**：是否继续此计划？（yes/no/modify）
```

## 重要说明

**关键**：规划者代理在您明确确认计划（“yes”、“proceed” 或类似肯定回复）之前将**不会**编写任何代码。

如需更改，请回复：
- `modify: [您的修改]`
- `different approach: [替代方案]`
- `skip phase 2 and do phase 3 first`

## 与其他命令的集成

计划后：
- 使用 `/tdd` 进行测试驱动开发
- 如遇构建错误，使用 `/build-and-fix`
- 使用 `/code-review` 审查已完成的实现

## 相关代理

此命令调用位于：
`~/.claude/agents/planner.md` 的 `planner` 代理
